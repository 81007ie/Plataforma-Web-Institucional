<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Iniciar Sesi칩n</title>
<link rel="icon" type="image/png" href="img/logo.png" />
<link rel="stylesheet" href="css/colors.css" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  body {
    font-family: var(--font-family);
    background: linear-gradient(135deg, var(--celeste), var(--azul-oscuro));
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
  }
  .login-container {
    background: var(--blanco);
    padding: 30px 25px;
    border-radius: 15px;
    box-shadow: 0px 8px 25px rgba(0,0,0,0.2);
    width: 90%;
    max-width: 400px;
  }
  .login-container h2 { text-align: center; margin-bottom: 25px; color: var(--azul-oscuro); }
  .login-container input { width: 95%; padding: 12px; margin: 10px 0; border: 1px solid var(--azul-borde); border-radius: 8px; }
  .password-container { position: relative; }
  .toggle-password { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; }
  button { width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 8px; cursor: pointer; background: var(--rojo); color: var(--blanco); font-weight: bold; }
  button:hover { background: var(--celeste); }
</style>
</head>
<body>
<div class="login-container">
  <img src="img/logo.png" alt="Logo" class="logo">
  <h2>Iniciar Sesi칩n</h2>
  <form id="loginForm">
    <input type="email" id="email" placeholder="Correo Electr칩nico" required autocomplete="email" />
    <div class="password-container">
      <input type="password" id="password" placeholder="Contrase침a" required autocomplete="current-password"/>
      <span class="toggle-password" id="togglePassword">MOSTRAR</span>
    </div>
    <button type="submit">INGRESAR</button>
  </form>
</div>

<script type="module">
import { db } from "./js/firebaseconfig.js";
import { collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const loginForm = document.getElementById("loginForm");
const passwordInput = document.getElementById("password");
const togglePassword = document.getElementById("togglePassword");

togglePassword.addEventListener("click", () => {
  const isPassword = passwordInput.type === "password";
  passwordInput.type = isPassword ? "text" : "password";
  togglePassword.textContent = isPassword ? "OCULTAR" : "MOSTRAR";
});

loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = document.getElementById("email").value.trim();
  const password = passwordInput.value;

  try {
    // 游댳 Buscar usuario por correo
    const q = query(collection(db, "usuarios"), where("correo", "==", email));
    const snap = await getDocs(q);

    if (snap.empty) {
      Swal.fire("Error", "Usuario no registrado.", "error");
      return;
    }

    const userDoc = snap.docs[0];
    const data = userDoc.data();

    // 游댳 Verificar si est치 bloqueado
    if (data.activo === false) {
      Swal.fire("Cuenta bloqueada", "Tu cuenta ha sido bloqueada. Comun칤cate con tu supervisor.", "error");
      return;
    }

    // 游댳 Verificar contrase침a (suponiendo que la guardas en Firestore como 'password')
    if (data.password !== password) {
      Swal.fire("Error", "Contrase침a incorrecta.", "error");
      return;
    }

    // 游댳 Guardar info local y redirigir
    localStorage.setItem("usuario", JSON.stringify({
      uid: userDoc.id,
      nombre: data.nombre,
      correo: data.correo,
      rol: data.rol || "Profesor",
      grado: data.grado || "",
      nivel: data.nivel || ""
    }));

    window.location.href = "dashboard.html";

  } catch (err) {
    console.error(err);
    Swal.fire("Error", "Hubo un problema al iniciar sesi칩n.", "error");
  }
});
</script>
</body>
</html>
