<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Iniciar Sesi√≥n</title>
<link rel="icon" type="image/png" href="img/logo.png" />
<link rel="stylesheet" href="css/colors.css" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  body {
    font-family: var(--font-family);
    background: linear-gradient(135deg, var(--celeste), var(--azul-oscuro));
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
  }
  .login-container {
    background: var(--blanco);
    padding: 30px 25px;
    border-radius: 15px;
    box-shadow: 0px 8px 25px rgba(0,0,0,0.2);
    width: 90%;
    max-width: 400px;
  }

  /* üî• CENTRAR LOGO */
  .logo {
    display: block;
    margin: 0 auto 15px auto;
    width: 120px;
  }

  .login-container h2 { text-align: center; margin-bottom: 25px; color: var(--azul-oscuro); }
  .login-container input { width: 95%; padding: 12px; margin: 10px 0; border: 1px solid var(--azul-borde); border-radius: 8px; }
  .password-container { position: relative; }
  .toggle-password { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; }
  button { width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 8px; cursor: pointer; background: var(--rojo); color: var(--blanco); font-weight: bold; }
  button:hover { background: var(--celeste); }
</style>

</head>
<body>
<div class="login-container">
  <img src="img/logo.png" alt="Logo" class="logo">
  <h2>Iniciar Sesi√≥n</h2>
  <form id="loginForm">
    <input type="email" id="email" placeholder="Correo Electr√≥nico" required autocomplete="email" />
    <div class="password-container">
      <input type="password" id="password" placeholder="Contrase√±a" required autocomplete="current-password"/>
      <span class="toggle-password" id="togglePassword">MOSTRAR</span>
    </div>
    <button type="submit">INGRESAR</button>
  </form>
</div>

<script type="module">
import { auth, db } from "./js/firebaseconfig.js";
import {
  signInWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

import {
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// =======================================
// üîπ MOSTRAR / OCULTAR CONTRASE√ëA
// =======================================
const passwordInput = document.getElementById("password");
const togglePassword = document.getElementById("togglePassword");

togglePassword.addEventListener("click", () => {
  const isPassword = passwordInput.type === "password";
  passwordInput.type = isPassword ? "text" : "password";
  togglePassword.textContent = isPassword ? "OCULTAR" : "MOSTRAR";
});

// =======================================
// üîπ LOGIN SEGURO
// =======================================
const loginForm = document.getElementById("loginForm");

loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const email = document.getElementById("email").value.trim();
  const password = passwordInput.value;

  try {
    // 1Ô∏è‚É£ INTENTAR LOGIN CON FIREBASE AUTH
    const cred = await signInWithEmailAndPassword(auth, email, password);
    const user = cred.user;

    // 2Ô∏è‚É£ LEER SU DOCUMENTO EN FIRESTORE
    const ref = doc(db, "usuarios", user.uid);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      Swal.fire("Error", "Tu usuario no est√° registrado en el sistema.", "error");
      await auth.signOut();
      return;
    }

    const data = snap.data();

    // 3Ô∏è‚É£ VERIFICAR SI EST√Å BLOQUEADO
    if (!data.activo) {
      Swal.fire(
        "Cuenta bloqueada",
        "Tu cuenta ha sido bloqueada por el administrativo.",
        "error"
      );
      await auth.signOut();
      return;
    }

    // 4Ô∏è‚É£ GUARDAR INFO EN LOCAL STORAGE
    localStorage.setItem("usuario", JSON.stringify({
      uid: user.uid,
      nombre: data.nombre,
      correo: data.correo,
      rol: data.rol,
      grado: data.grado || "",
      nivel: data.nivel || ""
    }));

    // 5Ô∏è‚É£ REDIRIGIR
    Swal.fire({
      icon: "success",
      title: "Bienvenido",
      text: "Inicio de sesi√≥n exitoso",
      timer: 1500,
      showConfirmButton: false
    }).then(() => {
      window.location.href = "dashboard.html";
    });

  } catch (error) {
    console.error(error);

    Swal.fire(
      "Error",
      "Correo o contrase√±a incorrectos.",
      "error"
    );
  }
});
</script>

</body>
</html>
